#!#!/bin/bash

rm ~/x &>/dev/null
sleep 2
clear
sleep 1
echo "Installing Termux-am..."
sleep 3
pkg install termux-am -y &>/dev/null
pkg install wget -y &>/dev/null
clear
termux-setup-storage & sleep 4 &>/dev/null

# Проверка доступа к storage
while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

clear
echo "Installing packages for Termux (quiet mode)..."

# Обновление системы
apt-get clean &>/dev/null
apt-get update &>/dev/null
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade &>/dev/null

# Стабильные репозитории и пакеты (тихо)
pkg install root-repo -y &>/dev/null
pkg install x11-repo -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install git -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-am -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install mesa-zink -y &>/dev/null
pkg install virglrenderer-mesa-zink -y &>/dev/null
pkg install vulkan-loader-android -y &>/dev/null
pkg install android-tools -y &>/dev/null
pkg install python-tkinter -y &>/dev/null

# XFCE и плагины
pkg install xfce4 -y &>/dev/null
apt install xfce4-whiskermenu-plugin -y &>/dev/null
apt install xfce4-screenshooter -y &>/dev/null
apt install xfce4-taskmanager -y &>/dev/null
apt install xfce4-docklike-plugin -y &>/dev/null
apt install matchbox-keyboard -y &>/dev/null

# Приложения
pkg install gimp -y &>/dev/null
pkg install mpv -y &>/dev/null
pkg install firefox -y &>/dev/null
pkg install vlc -y &>/dev/null
pkg install vlc-qt -y &>/dev/null
pkg install abiword -y &>/dev/null
apt install ristretto -y &>/dev/null

clear

# Удаляем старый glibc
if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous Glibc. Continue? (Y/n) "
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf $PREFIX/glibc
    else
        exit 1
    fi
fi
sleep 3
echo "Packages for Termux installed."
sleep 1
clear
sleep 3
echo "Installing Mobox-XFCE..."

# Функция для скачивания с GitLab
function wget-git-q {
    wget -q --retry-connrefused --tries=0 --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" \
    "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

sleep 2
echo "Updating package-manager..."
mkdir -p $PREFIX/glibc/opt/package-manager/installed

# Твой токен и ID репозитория
echo "PRIVATE_TOKEN=glpat-HXwPTFW7Er-B1Dx_GLhPq286MQp1Omo3dms4Cw.01.1200ezla5
PROJECT_ID=77055448" > $PREFIX/glibc/opt/package-manager/token

. $PREFIX/glibc/opt/package-manager/token
if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed"
    exit 1
fi

. $PREFIX/glibc/opt/package-manager/package-manager
sync-all

sync-package mobox-wow64-glibc-xfce

chmod +x $PREFIX/glibc/opt/scripts/mobox-xfce
ln -sf $PREFIX/glibc/opt/scripts/mobox-xfce $PREFIX/bin/mobox-xfce
echo "To start - type \"mobox-xfce\""
